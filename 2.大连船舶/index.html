<!doctype html>
<html>
<title>大连船舶</title>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/layer/layer.js"></script>
	<!-- 右键菜单插件 -->
	<script type="text/javascript" src="js/context/context.js"></script>
	<script type="text/javascript" src="js/drag.js"></script>
	<link rel="stylesheet" type="text/css" href="js/context/context.standalone.css">
	<style type="text/css">
		html,
		body {
			margin: 0;
			padding: 0;
			font: 14px/1.5em simsun;
			overflow: hidden;
		}

		#canvas {
			position: absolute;
			left: 0px;
			top: 0px;
			z-index: 9;
			border: 2px dashed #ccc;
			padding: 10px;
			background: #fff;
		}

		.transparent {
			filter: alpha(opacity=50);
			-moz-opacity: 0.5;
			-khtml-opacity: 0.5;
			opacity: 0.5;
		}

		.box {
			width: 200px;
			height: 100px;
			cursor: move;
			position: absolute;
			top: 30px;
			left: 30px;
			z-index: 99;
		}

		.box .bg {
			width: 100%;
			height: 100%;
			background-color: orange;
		}

		.box .coor {
			width: 10px;
			height: 10px;
			overflow: hidden;
			cursor: se-resize;
			position: absolute;
			right: 0;
			bottom: 0;
			background-color: red;
		}

		.box .rotate {
			width: 10px;
			height: 10px;
			overflow: hidden;
			cursor: all-scroll;
			cursor: url("./img/rotate.png"),auto;
			position: absolute;
			left: 0;
			bottom: 0;
			background-color: #007eff;
			display: none;
		}

		.box .content {
			position: absolute;
			left: 50%;
			top: 50%;
			z-index: 99;
			text-align: center;
			font: bold 14px/1.5em simsun;
		}

		#debug {
			position: absolute;
			right: 10px;
			top: 10px;
			z-index: 88;
			border: 1px solid #ccc;
			width: 100px;
			height: 100px;
			background: #fff;
		}

		#toolbar {
			position: absolute;
			left: 10px;
			top: 10px;
			z-index: 88;
		}

		.box .bg {
			background-size: contain;
		}

		.chuan {
			background: url(./img/chuan.png) no-repeat center;
			/* ie8 */
			background: none\9;
			filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(src='./img/chuan.png',sizingMethod='scale');
		}

		.chuan_tou {
			background: url(./img/chuan_tou.png) no-repeat center;
			/* ie8 */
			background: none\9;
			filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(src='./img/chuan_tou.png',sizingMethod='scale');
		}

		.chuan_wei {
			background: url(./img/chuan_wei.png) no-repeat center;
			/* ie8 */
			background: none\9;
			filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(src='./img/chuan_wei.png',sizingMethod='scale');
		}

		.chuan_zhong {
			background: url(./img/chuan_zhong.png) no-repeat center;
			/* ie8 */
			background: none\9;
			filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(src='./img/chuan_zhong.png',sizingMethod='scale');
		}

		ul li {
			list-style: none;
			line-height: 30px;
		}
	</style>
	<!--[if IE]>
    <script type="text/javascript" src="./js/html5.js"></script>
    <script type="text/javascript" src="./js/excanvas.compiled.js"></script>
    <![endif]-->
</head>

<body class="list">
	<!-- <pre id="debug"></pre> -->
	<div id="toolbar">
		<!-- <input type="button" value="添加区域" class="btn" id="btn_add" /> -->
		<input type="button" value="锁定区域" class="btn" id="btn_lock" />
		<input type="button" value="获取数据" class="btn" id="btn_save" />
	</div>
	<div id="canvas">
		<img src="./img/demo.png" id="pic"/>
	</div>
</body>

</html>
<script>
	$(function () {
		//初始化界面宽度
		$("#canvas, #pic").width(document.documentElement.clientWidth);
		$("#canvas, #pic").height(document.documentElement.clientWidth);

		//初始化计数器
		var num = 0;
		//区块锁定标识
		var lock = false;
		//加载layer拓展
		layer.config({
			extend: 'extend/layer.ext.js'
		});
		//右键菜单参数
		context.init({
			fadeSpeed: 100,
			filter: function ($obj) {},
			above: 'auto',
			preventDoubleContext: true,
			compress: false
		});
		//调试输出方法
		function debug(msg) {
			$("#debug").text(msg);
		}

		function createBox(data) {
			var dataId = data.id || '';
			var value = data.text || '';
			var className = data.className || '';
			var color = data.color || '';
			var height = data.height || 0;
			var width = data.width || 0;
			var pageX = data.pageX || 0;
			var pageY = data.pageY || 0;
			var dataInfo = JSON.stringify(data.info).replace(/"/g,"'") || '';
			var dataInit = data.isInit || 0;

			//更新计数器并记录当前计数
			var curNum = num++;
			//将相应的图标放到界面上
			var pos = $("#canvas").position();
			var box = $('<div class="box" rel="' + curNum + '" dataId="' + dataId + '" dataInfo="'+ dataInfo +'" dataInit="'+ dataInit +'"><pre class="content">' +
				value + '</pre><div class="bg transparent ' + className + '" style="background-color:' +
				color + '"></div><div class="coor transparent"></div><div class="rotate transparent"></div></div>').css({
				width: width,
				height: height,
				top: pageY > 0 ? pageY : (pos.top > 0 ? 0 : pos.top * -1 + 50),
				left: pageX > 0 ? pageX : (pos.left > 0 ? 0 : pos.left * -1 + 30)
			}).appendTo("#canvas");

			//计算文本位置
			box.find('.content').css({
				marginLeft: box.find('.content').width() / 2 * -1,
				marginTop: box.find('.content').height() / 2 * -1
			});
			//创建右键菜单
			context.attach('.box[rel=' + curNum + ']', [{
					header: '操作'
				},
				{
					text: '编辑区域说明',
					action: function (e) {
						e.preventDefault();
						layer.prompt({
							title: '请输入区域说明',
							formType: 2,
							value: $('.box[rel=' + curNum + '] .content').text()
						}, function (value, index, elem) {
							layer.close(index);
							var curCont = $('.box[rel=' + curNum + '] .content');
							curCont.text(value).css({
								marginLeft: curCont.width() / 2 * -1,
								marginTop: curCont.height() / 2 * -1
							});
						});
					}
				},
				{
					text: '更改区域尺寸',
					action: function (e) {
						e.preventDefault();
						layer.prompt({
							title: '请输入区域尺寸（宽,高），最小值：30',
							formType: 0,
							value: $('.box[rel=' + curNum + ']').width() + "," + $(
								'.box[rel=' + curNum + ']').height()
						}, function (value, index, elem) {
							var reg = /^[0-9]+,[0-9]+$/;
							if (!reg.test(value)) {
								alert('输入格式不正确，例：100,200');
								return;
							}
							var size = value.split(',');
							var box = $('.box[rel=' + curNum + ']');
							box.css({
								width: size[0] < 30 ? 30 : size[0],
								height: size[1] < 30 ? 30 : size[1]
							});
							layer.close(index);
						});
					}
				},
				{
					text: '删除区域',
					action: function (e) {
						e.preventDefault();
						$('.box[rel=' + curNum + ']').remove();
					}
				},
				{
					divider: true
				},
				{
					header: '更改颜色'
				},
				{
					text: '<font color="orange">橙色</font>',
					action: function (e) {
						e.preventDefault();
						$('.box[rel=' + curNum + '] .bg').css('background-color', 'orange');
					}
				},
				{
					text: '<font color="red">红色</font>',
					action: function (e) {
						e.preventDefault();
						$('.box[rel=' + curNum + '] .bg').css('background-color', 'red');
					}
				},
				{
					text: '<font color="blue">蓝色</font>',
					action: function (e) {
						e.preventDefault();
						$('.box[rel=' + curNum + '] .bg').css('background-color', 'blue');
					}
				},
				{
					text: '<font color="green">绿色</font>',
					action: function (e) {
						e.preventDefault();
						$('.box[rel=' + curNum + '] .bg').css('background-color', 'green');
					}
				},
				{
					text: '<font color="purple">紫色</font>',
					action: function (e) {
						e.preventDefault();
						$('.box[rel=' + curNum + '] .bg').css('background-color', 'purple');
					}
				},
				{
					text: '<font color="yellow">黄色</font>',
					action: function (e) {
						e.preventDefault();
						$('.box[rel=' + curNum + '] .bg').css('background-color', 'yellow');
					}
				}
			]);
		}
		//添加区域
		$("#btn_add").click(function () {
			//弹出区域说明输入框
			layer.prompt({
				title: '请输入区域说明',
				formType: 2 //0:input,1:password,2:textarea
			}, function (value, index, elem) {
				layer.close(index);
				createBox({
					text: value,
					width: 200,
					height: 100
				});
			});
		});
		//锁定区域
		$('#btn_lock').click(function () {
			if (lock) {
				$(this).val("锁定区域");
				lock = false;
				$('.box .coor').show();
			} else {
				$(this).val("解锁区域");
				lock = true;
				$('.box .coor').hide();
			}
		});
		//获取所有区块
		$('#btn_save').click(function () {
			var data = [];
			$('.box').each(function () {
				if($(this).attr("datainit")=="true"){
					return;
				}
				var box = {};
				box['id'] = $(this).attr('dataId');
				box['text'] = $(this).find('.content').text();
				box['color'] = $(this).find('.bg').css('background-color');
				box['height'] = $(this).height();
				box['width'] = $(this).width();
				box['pageX'] = $(this).position().left;
				box['pageY'] = $(this).position().top;
				box['info'] = $(this).attr("datainfo");
				box['isInit'] = $(this).attr("datainit");
				// console.dir(box);
				data.push(box);
			});
			console.dir(data);
			// console.log("重新渲染");
			// initPage(data);
		});
		//创建拖拽方法
		$("#canvas").mousedown(function (e) {
			var canvas = $(this);
			e.preventDefault();
			var pos = $(this).position();
			this.posix = {
				'x': e.pageX - pos.left,
				'y': e.pageY - pos.top
			};
			$.extend(document, {
				'move': true,
				'move_target': this,
				'call_down': function (e, posix) {
					canvas.css({
						'cursor': 'move',
						'top': e.pageY - posix.y,
						'left': e.pageX - posix.x
					});
				},
				'call_up': function () {
					canvas.css('cursor', 'default');
				}
			});
		}).on('mousedown', '.box', function (e) {
			console.log(e);
			if (lock) return;
			if($(this).attr("datainit")=="true"){
				//克隆一份
				$(this).clone(true).appendTo("#canvas");
				$(this).attr("datainit","false");
			}
			var pos = $(this).position();
			this.posix = {
				'x': e.pageX - pos.left,
				'y': e.pageY - pos.top
			};
			$.extend(document, {
				'move': true,
				'move_target': this
			});
			e.stopPropagation();
		}).on('mousedown', '.box .coor', function (e) {
			var $box = $(this).parent();
			var posix = {
				'w': $box.width(),
				'h': $box.height(),
				'x': e.pageX,
				'y': e.pageY
			};
			$.extend(document, {
				'move': true,
				'call_down': function (e) {
					$box.css({
						'width': Math.max(30, e.pageX - posix.x + posix.w),
						'height': Math.max(30, e.pageY - posix.y + posix.h)
					});
				}
			});
			e.stopPropagation();
		}).on('mousedown', '.box .rotate', function (e) {
			var roateBox = $(this).parent();
			//TODO 旋转
			
		});
		//测试加载
		var loadData = [{
				id: 1001,
				text: "船16",
				info: {
					name: '船16',
					tonnage: '100万吨',
					owner: '船东',
					device: '设备A',
					other: '其他属性'
				},
				className: "chuan",
				color: "rgb(255, 0, 0)",
				height: 50,
				width: 50,
				pageX: 0,
				pageY: 0,
				isInit: true,
			},
			{
				id: 1002,
				text: "船17",
				info: {
					name: '船17',
					tonnage: '100万吨',
					owner: '船东',
					device: '设备A',
					other: '其他属性'
				},
				className: "chuan",
				color: "rgb(255, 0, 0)",
				height: 50,
				width: 50,
				pageX: 0,
				pageY: 0,
				isInit: true,
			},
			{
				id: 1003,
				text: "船18",
				info: {
					name: '船18',
					tonnage: '100万吨',
					owner: '船东',
					device: '设备A',
					other: '其他属性'
				},
				className: "chuan",
				color: "rgb(255, 0, 0)",
				height: 50,
				width: 50,
				pageX: 0,
				pageY: 0,
				isInit: true,
			},
			{
				id: 1004,
				text: "船19",
				info: {
					name: '船19',
					tonnage: '100万吨',
					owner: '船东',
					device: '设备A',
					other: '其他属性'
				},
				className: "chuan",
				color: "rgb(255, 0, 0)",
				height: 50,
				width: 50,
				pageX: 0,
				pageY: 0,
				isInit: true,
			},
			{
				id: 1005,
				text: "船头20",
				info: {
					name: '船头20',
					tonnage: '100万吨',
					owner: '船东',
					device: '设备A',
					other: '其他属性'
				},
				className: "chuan_tou",
				color: "rgb(0, 0, 255)",
				height: 50,
				width: 50,
				pageX: 0,
				pageY: 0,
				isInit: true,
			},
			{
				id: 1006,
				text: "船尾21",
				info: {
					name: '船尾21',
					tonnage: '100万吨',
					owner: '船东',
					device: '设备A',
					other: '其他属性'
				},
				className: "chuan_wei",
				color: "rgb(255, 165, 0)",
				height: 50,
				width: 50,
				pageX: 0,
				pageY: 0,
				isInit: true,
			},
			{
				id: 1007,
				text: "船中22",
				info: {
					name: '船中22',
					tonnage: '100万吨',
					owner: '船东',
					device: '设备A',
					other: '其他属性'
				},
				className: "chuan_zhong",
				color: "rgb(0, 128, 0)",
				height: 50,
				width: 50,
				pageX: 0,
				pageY: 0,
				isInit: true,
			},
			{
				id: 1008,
				text: "船23",
				info: {
					name: "船23",
					tonnage: '100万吨',
					owner: '船东',
					device: '设备A',
					other: '其他属性'
				},
				className: "chuan",
				color: "rgb(255, 0, 0)",
				height: 50,
				width: 50,
				pageX: 0,
				pageY: 0,
				isInit: true,
			}
		];

		var j = 1;
		function initPage(loadData) {
			$.each(loadData, function (i, row) {
				if(row.isInit){
					row.pageX = j%2*100;
					row.pageY = Math.round(j/2)*80;
					j++;
				}
				createBox(row);
			});
		}

		initPage(loadData);
		

		//双击展示信息
		$(".box").dblclick(function(){
			console.log($(this).attr("datainfo"));
			var dataInfo = JSON.parse($(this).attr("datainfo").replace(/'/g,'"'));
			console.log(dataInfo);
			var htmlContent = "<ul><li>名称："+dataInfo.name+"</li><li>吨位："+dataInfo.tonnage+"</li><li>船东："+dataInfo.owner+"</li><li>设备："+dataInfo.device+"</li><li>其他："+dataInfo.other+"</li></ul>";
			layer.open({
				type: 1,
				anim: 2,
				title: '船只信息',
				area: ['300px', '240px'], //宽高
				content: htmlContent
			});
		});
	});
</script>